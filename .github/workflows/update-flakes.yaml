# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Update Flake and Dependencies

on:
  workflow_dispatch:
    inputs:
      auto-merge:
        description: "Auto-merge PR if checks pass"
        type: boolean
        required: false
        default: true
  schedule:
    # Run every Friday at 4 AM UTC
    - cron: "0 4 * * 5"

run-name: Update flake inputs and dependencies

permissions:
  contents: write
  pull-requests: write
  checks: read

env:
  GIT_USERNAME: github-actions[bot]
  GIT_EMAIL: github-actions[bot]@users.noreply.github.com

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: polarmutex
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true

      - name: Configure Git
        run: |
          git config --local user.email "${{ env.GIT_EMAIL }}"
          git config --local user.name "${{ env.GIT_USERNAME }}"

      - name: Update flake.lock
        id: flake-update
        run: |
          echo "Updating flake.lock..."
          nix flake update --commit-lock-file --commit-lockfile-summary "chore(flake): update flake.lock" || echo "No flake updates"
          if git diff --quiet HEAD~1 2>/dev/null; then
            echo "updated=false" >> "$GITHUB_OUTPUT"
          else
            echo "updated=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update npins (main)
        id: npins-main
        continue-on-error: true
        run: |
          echo "Updating npins/sources.json..."
          if [ -d "npins" ] && [ -f "npins/sources.json" ]; then
            nix run .#npins -- -d npins update
            if ! git diff --quiet; then
              git add npins/
              git commit -m "chore(npins): update main dependencies"
              echo "updated=true" >> "$GITHUB_OUTPUT"
            else
              echo "updated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update npins plugins (start)
        id: npins-start
        continue-on-error: true
        run: |
          echo "Updating npins-plugins/start.json..."
          if [ -f "npins-plugins/start.json" ]; then
            nix run .#npins -- -d npins-plugins update --lock-file start.json
            if ! git diff --quiet; then
              git add npins-plugins/
              git commit -m "chore(npins): update start plugins"
              echo "updated=true" >> "$GITHUB_OUTPUT"
            else
              echo "updated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update npins plugins (opt)
        id: npins-opt
        continue-on-error: true
        run: |
          echo "Updating npins-plugins/opt.json..."
          if [ -f "npins-plugins/opt.json" ]; then
            nix run .#npins -- -d npins-plugins update --lock-file opt.json
            if ! git diff --quiet; then
              git add npins-plugins/
              git commit -m "chore(npins): update opt plugins"
              echo "updated=true" >> "$GITHUB_OUTPUT"
            else
              echo "updated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update npins tree-sitter grammars
        id: npins-ts
        continue-on-error: true
        run: |
          echo "Updating npins-ts-grammars/sources.json..."
          if [ -d "npins-ts-grammars" ] && [ -f "npins-ts-grammars/sources.json" ]; then
            nix run .#npins -- -d npins-ts-grammars update
            if ! git diff --quiet; then
              git add npins-ts-grammars/
              git commit -m "chore(npins): update tree-sitter grammars"
              echo "updated=true" >> "$GITHUB_OUTPUT"
            else
              echo "updated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run nix-update
        id: nix-update
        continue-on-error: true
        run: |
          echo "Running nix-update..."
          # Install nix-update if needed
          nix profile install nixpkgs#nix-update || true

          # Update packages that can be auto-updated
          # Add package names here as needed
          PACKAGES=""

          if [ -n "$PACKAGES" ]; then
            for pkg in $PACKAGES; do
              echo "Updating $pkg..."
              nix-update "$pkg" --flake --commit || echo "Failed to update $pkg"
            done
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "No packages configured for nix-update"
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create summary
        run: |
          {
            echo "## Update Summary"
            echo ""
            echo "| Component | Status |"
            echo "|-----------|--------|"
            echo "| Flake | ${{ steps.flake-update.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
            echo "| Npins (main) | ${{ steps.npins-main.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
            echo "| Npins (start plugins) | ${{ steps.npins-start.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
            echo "| Npins (opt plugins) | ${{ steps.npins-opt.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
            echo "| Npins (tree-sitter) | ${{ steps.npins-ts.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
            echo "| Nix-update | ${{ steps.nix-update.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v8
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          branch: automated-updates
          delete-branch: true
          title: "chore: update flake inputs and dependencies"
          body: |
            ## Automated Dependency Updates

            This PR contains automated updates for:
            - âœ… Flake inputs (flake.lock)
            - âœ… Npins dependencies
            - âœ… Plugin dependencies
            - âœ… Tree-sitter grammars

            ### Update Details
            - Flake: ${{ steps.flake-update.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }}
            - Npins (main): ${{ steps.npins-main.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }}
            - Npins (start): ${{ steps.npins-start.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }}
            - Npins (opt): ${{ steps.npins-opt.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }}
            - Npins (ts-grammars): ${{ steps.npins-ts.outputs.updated == 'true' && 'âœ… Updated' || 'â­ï¸ No changes' }}

            **Triggered by:** ${{ github.event_name == 'workflow_dispatch' && 'Manual trigger' || 'Scheduled run' }}

            ---

            ğŸ¤– This PR was automatically created by the update-flakes workflow.
            ${{ (github.event_name == 'schedule' || inputs.auto-merge) && 'ğŸ”„ Will auto-merge when checks pass.' || '' }}
          labels: |
            dependencies
            automated
          draft: false

      - name: Enable auto-merge
        if: |
          steps.create-pr.outputs.pull-request-number &&
          (github.event_name == 'schedule' || inputs.auto-merge)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
        run: |
          echo "Enabling auto-merge for PR #${PR_NUMBER}"
          gh pr merge "${PR_NUMBER}" --auto --squash --delete-branch
